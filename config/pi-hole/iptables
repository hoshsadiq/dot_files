#!/bin/sh

# see below URL for more information
# https://pi-hole.net/2018/02/02/why-some-pages-load-slow-when-using-pi-hole-and-how-to-fix-it/

# todo refactor this to be nicer and more digestable (i.e. separate out the files etc)

cat <<'IP6TABLES' > /etc/iptables/rules.v6
# Generated by ip6tables-save v1.6.0 on Sat Jun 30 04:38:06 2018
*filter
:INPUT ACCEPT [103:19729]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [124:12082]
-A INPUT -p tcp -m tcp --dport 443 -j REJECT --reject-with tcp-reset
-A INPUT -p udp -m udp --dport 80 -j REJECT --reject-with icmp6-port-unreachable
-A INPUT -p udp -m udp --dport 443 -j REJECT --reject-with icmp6-port-unreachable
COMMIT
# Completed on Sat Jun 30 04:38:06 2018
IP6TABLES

cat <<'IPTABLES' > /etc/iptables/rules.v4
# Generated by iptables-save v1.6.0 on Sat Jun 30 04:38:03 2018
*filter
:INPUT ACCEPT [1714:183012]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [1196:148531]
-A INPUT -p tcp -m tcp --dport 443 -j REJECT --reject-with tcp-reset
-A INPUT -p udp -m udp --dport 80 -j REJECT --reject-with icmp-port-unreachable
-A INPUT -p udp -m udp --dport 443 -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Sat Jun 30 04:38:03 2018
IPTABLES

cat <<'SHELL' > /etc/network/if-pre-up.d/iptables
#!/bin/sh
/sbin/iptables-restore < /etc/iptables/rules.v4
/sbin/ip6tables-restore < /etc/iptables/rules.v6
SHELL

chmod +x /etc/network/if-pre-up.d/iptables
